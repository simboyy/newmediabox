{"version":3,"sources":["api/pay/index.js"],"names":["controller","auth","sendmail","config","request","require","shortId","sha512","FormData","http","router","ParseMsg","msg","parts","split","result","key","bits","decodeURIComponent","UrlIfy","fields","delim","fields_string","CreateHash","values","MerchantKey","string","toUpperCase","hash","CreateMsg","post","req","res","data","body","amount","Math","round","total","stripe","process","env","STRIPE_APIKEY","charges","create","currency","source","stripeToken","description","err","charge","status","json","id","requestId","message","address","recipient_name","name","line1","city","postal_code","zip","state","country","orderDetails","orderNo","generate","uid","email","phone","items","payment","cart","currency_code","exchange_rate","created","payment_method","d","mailParams","to","send","mailOptions","orderPlaced","get","console","log","query","JSON","parse","options","subtotal","discount","shipping","isNaN","k","length","i","price","quantity","push","sku","url","image","slug","cmd","configure","payReq","DOMAIN","country_code","error","code","response","details","redirect","payer","payer_info","payer_id","transactions","custom","invoice_number","item_list","shipping_address","created_time","links","forEach","linkObj","rel","href","method","hasOwnProperty","approval_url","PS_ERROR","PS_OK","PS_CREATED_BUT_NOT_PAID","PS_CANCELLED","PS_FAILED","PS_PAID","PS_AWAITING_DELIVERY","PS_DELIVERED","PS_AWAITING_REDIRECT","SITE_URL","paynowJSONObject","reference","additionalInfo","returnUrl","resulturl","authemail","formData","httpResponse","encodeURIComponent","validateHash","theProcessUrl","pollUrl","pollurl","Date","now","paymentId","payerId","PayerID","execute","findOneAndUpdate","upsert","setDefaultsOnInsert","runValidators","exec","then","doc","findOne","$sort","orderUpdated","paynowreference","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["'use strict';\n\nimport {Router} from 'express';\nimport * as controller from './pay.controller';\nimport * as auth from '../../auth/auth.service';\nimport paypal from 'paypal-rest-sdk';\nimport Order from '../order/order.model';\nimport jsonpatch from 'fast-json-patch';\nimport * as sendmail from '../sendmail/send'\nimport * as config from '../../config/environment/shared'\nimport fetch from 'node-fetch';\n\nvar request = require('request');\nvar shortId = require('shortid');\nvar sha512 = require('js-sha512');\nvar FormData = require('form-data');\nvar http = require('http');\n\n\nvar router = new Router();\n\nfunction ParseMsg(msg) {\n\n    var msg = msg+ '';\n\n   var  parts =  msg.split(\"&\");\n    var result = [];\n    for(var key in parts) {\n        var bits = parts[key].split(\"=\", 2);\n        result[bits[0]] = decodeURIComponent(bits[1]);\n    }\n\n    return result;\n}\n\nfunction UrlIfy(fields) {\n\n   // console.log(fields);\n  //url-ify the data for the POST\n    var delim = \"\";\n    var fields_string = \"\";\n    for(var key in fields) {\n        fields_string += delim + key +'=' + fields[key];\n        //console.log(fields_string);\n        delim = \"&\";\n    }\n\n    return fields_string;\n}\n\n\nfunction CreateHash(values,MerchantKey) {\n  var string = \"\";\n    for(var key in values) {\n        if( key.toUpperCase() !== \"HASH\" ){\n            string += values[key];\n        }\n    }\n    string += MerchantKey;\n    var hash = sha512(string);\n    return hash.toUpperCase();\n}\n\n\n\nfunction CreateMsg(values,MerchantKey) {\n\n   \n\n    var fields = [];\n    for(var key in values) {\n       \n       fields[key] = values[key];\n\n    }\n\n    fields[\"hash\"] = CreateHash(values, MerchantKey);\n\n\n\n    var fields_string = fields;\n\n    //console.log(fields[\"hash\"]);\n    return fields_string;\n}\n\n\n\n\n\nrouter.post('/stripe', function(req, res) {\n    var data = req.body\n    var amount = Math.round(data.total*100)\n    var stripe = require(\"stripe\")(process.env.STRIPE_APIKEY);\n\n    stripe.charges.create({\n    amount: amount,\n    currency: \"usd\",\n    source: data.stripeToken, // obtained with Stripe.js\n    description: \"Charge for mediabox.co.zw\"\n    }, function(err, charge) {\n        var status\n        if(err){\n            status = 'Payment failed'\n            return res.status(400).json({id: err.requestId, message: err.message});\n        }\n        else{\n            status = 'Paid'\n            var address = {recipient_name: data.name, line1: data.address, city: data.city, postal_code: data.zip, state: data.state,country: data.country}\n            var orderDetails = {\n                orderNo: shortId.generate(),\n                uid: data.uid,\n                email: data.email,\n                phone: data.phone,\n                address: address,\n                status: status,\n                items: data.items,\n                payment : {id: charge.id, state:charge.status, cart:null},\n                amount: {total: amount/100, currency: data.currency_code},\n                exchange_rate: data.exchange_rate,\n                created: charge.created,\n                payment_method: 'Credit Card',\n                                \n            }\n            // Order.create is from order.model not from order.controller\n            Order.create(orderDetails, function(err,d){\n                var mailParams = orderDetails\n                mailParams.id = charge.id\n                mailParams.to = data.email\n                sendmail.send(config.mailOptions.orderPlaced(mailParams))\n                return res.status(201).json({id: charge.id, message: status});\n            })\n        }\n    });\n})\n\n\n\n\nrouter.get('/prepare', function(req, res) {\n\n\n    console.log(req.query);\n\n    var items = []\n    var data = JSON.parse(req.query.data)\n    var options = JSON.parse(req.query.options)\n    var total = 0\n    var subtotal = 0\n    var discount = 0\n    var shipping = Math.round(options.shipping*100)/100\n    if (isNaN(options.exchange_rate) || options.exchange_rate === '') // If exchange rate is not a float value, force this to 1\n        options.exchange_rate = 1\n    for (var k = 0; k < data.length; k++) {\n       var i = data[k]\n       var price = Math.round(i.price*100)/100\n       subtotal = subtotal + price * i.quantity\n       items.push({sku: i.sku, name: i.name, url: i.image, description: i.slug, price: price, quantity: i.quantity, currency: options.currency_code})\n    }\n\n    if(options.discount>0){\n        discount = -Math.round(options.discount*100)/100\n        items.push({sku: '#', name: 'Coupon Discount', url: '-', description: '-', price: discount, quantity: 1, currency: options.currency_code})\n    }\n    subtotal = subtotal + discount\n    total = subtotal \n\n    //configure for sandbox environment\n    if(req.query.cmd){\n    \n    paypal.configure({\n      'mode': 'sandbox', //sandbox or live\n      'client_id': 'ARYkOSdmccmnPqcbTmpPF6TA-AQS7zIEt7NCBNEY--Y1doAnulMTGLb4fdIB4x5xCyckqhhIc92568fu',\n      'client_secret': 'EBnfwROb_fv8YcqN_Nwm9mjLVnEloHaKpVLJbc4RTdkKLB4KdAp1fdRdHO3paf1_Kovnj-BgnZLW5iJd'\n    });\n\n    var shortId = require('shortid');\n    var orderNo = shortId.generate();\n    //build PayPal payment request\n    var payReq = {\n        'intent': 'sale',\n        'redirect_urls': {\n            'return_url': process.env.DOMAIN+'/api/pay/process',\n            'cancel_url': process.env.DOMAIN+'/api/pay/cancel'\n        },\n        'payer': {\n            'payment_method': 'paypal',\n            'payer_info': {\n                'email': options.email,\n                'payer_id': options.uid\n            }\n        },\n        \"transactions\": [\n            {\n                \"amount\": {\n                    \"total\": total,//Math.round(options.total*options.exchange_rate*100)/100,\n                    \"currency\": options.currency_code,\n                    \"details\": {\n                        \"subtotal\": subtotal,//Math.round(options.subtotal*options.exchange_rate*100)/100,\n                        \"shipping\": shipping\n                    }\n                },\n                \"invoice_number\": orderNo,\n                \"custom\":options.phone,\n                \"item_list\": { \n                    \"items\":items,\n                    \"shipping_address\":{\n                        \"recipient_name\":options.recipient_name,\n                        \"line1\":options.line1,\n                        \"city\":options.city,\n                        \"postal_code\":options.postal_code,\n                        \"state\": \"-\",\n                        \"country_code\":options.country_code\n                    }\n                }\n            }\n        ]\n    };\n\n    paypal.payment.create(payReq, function(error, payment) {\n        if (error) {\n            console.log('########################## Error', error);\n            // string = encodeURIComponent(error.response.details[0].issue);\n            var msg = '', id = '', code=''\n            if(error.code === 'ENOTFOUND' || error.code === 'ETIMEDOUT'){\n                msg = 'Not connected to internet'\n            }\n            else{\n                code = '404'\n                msg = JSON.stringify(error.response.details)\n            }\n            res.redirect('/checkout?id='+id+'&msg=' + msg)\n        } else {\n            // console.log('paymentinfooooooooooooooooooooooooo',JSON.stringify(payment));\n            var orderDetails = {uid: payment.payer.payer_info.payer_id,email: options.email,\n                phone: payment.transactions[0].custom,\n                orderNo: payment.transactions[0].invoice_number,\n                address: payment.transactions[0].item_list.shipping_address,\n                status: 'Payment Initiated',\n                items: payment.transactions[0].item_list.items,\n                payment : {id: payment.id, state:payment.state, cart:payment.cart,email:payment.payer.payer_info.email},\n                amount: payment.transactions[0].amount,\n                exchange_rate: options.exchange_rate,\n                created: payment.created_time,\n                payment_method: payment.payer.payment_method\n            }\n            // When order.status is null, the client will replace with the Array[0] of order status at Settings page\n            // Order.create is from order.model not from order.controller\n            Order.create(orderDetails)\n                \n            //capture HATEOAS links\n            var links = {};\n            payment.links.forEach(function(linkObj) {\n                links[linkObj.rel] = {\n                    'href': linkObj.href,\n                    'method': linkObj.method\n                };\n            })\n\n            //if redirect url present, redirect user\n            if (links.hasOwnProperty('approval_url')) {\n                res.redirect(links.approval_url.href);\n            } else {\n                console.error('no redirect URI present');\n            }\n        }\n    });\n\n}else{\n\n    var shortId = require('shortid');\n    //console.log(req.query.data);\n     var data = JSON.parse(req.query.data)\n     var amount = Math.round(data.total*100)\n     var orderNo = shortId.generate();\n\n    /**Define constants ***/\n\n    const PS_ERROR = \"Error\";\n    const PS_OK = \"Ok\";\n    const PS_CREATED_BUT_NOT_PAID = \"created but not paid\";\n    const PS_CANCELLED = \"cancelled\";\n    const PS_FAILED = \"failed\";\n    const PS_PAID = \"paid\";\n    const PS_AWAITING_DELIVERY = \"awaiting delivery\";\n    const PS_DELIVERED = \"delivered\";\n    const PS_AWAITING_REDIRECT = \"awaiting redirect\";\n    const SITE_URL = \"http://www.mediabox.co.zw\"\n\n\n\n    var paynowJSONObject = {\n        id:3100,\n        reference:orderNo,\n        amount:total,\n        additionalInfo:'',\n        returnUrl:'http://www.mediabox.co.zw/api/pay/gettingbackfrompaynow',\n        resulturl :'http://www.mediabox.co.zw/api/pay/paynowupdatingus',\n        authemail:'',\n        status:'message'\n       \n    }\n\n\n    var formData = CreateMsg(paynowJSONObject, 'b717de9d-d716-49ae-abae-df8279ceda9b');\n\n\n\n    request.post({url:'https://www.paynow.co.zw/interface/initiatetransaction', formData: formData}, function(err, httpResponse, body) {\n      if (err) {\n         console.log('########################## Error', err);\n            var status = 'Payment failed'\n            //return res.status(400).json({id: error.requestId, message: error.message});\n            var string = encodeURIComponent('Payment Failed');\n           res.redirect('/checkout?msg=' + string);\n        \n      }                \n      else{\n\n          \n        var msg = ParseMsg(body);\n \n\n        \n        //first check status, take appropriate action\n        if (msg[\"status\"] === PS_ERROR){\n        \n             error = msg['error'];\n             status = 'Payment failed'\n            ///return res.status(400).json({id: error.requestId, message: error});\n            var string = encodeURIComponent('Payment Failed');\n            res.redirect('/checkout?msg=' + string);\n        }\n        else if (msg[\"status\"] === PS_OK){\n            \n            //second, check hash\n            var validateHash = CreateHash(msg,'b717de9d-d716-49ae-abae-df8279ceda9b' );\n            if(validateHash !== msg[\"hash\"]){\n              error =  \"Paynow reply hashes do not match : \" +validateHash + \" - \" + msg[\"hash\"];\n            }\n            else\n            {\n                var theProcessUrl = msg[\"browserurl\"];\n                var pollUrl = msg[\"pollurl\"];\n\n                /***** IMPORTANT ****\n                On User has approved paying you, maybe they are awaiting delivery etc\n                \n                    Here is where you\n                    1. Save the PollURL that we will ALWAYS use to VERIFY any further incoming Paynow Notifications FOR THIS PARTICULAR ORDER\n                    1. Update your local shopping cart of Payment Status etc and do appropriate actions here, Save any other relavant data to DB\n                    2. Email, SMS Notifications to customer, merchant etc\n                    3. Any other thing\n                \n                *** END OF IMPORTANT ****/\n                \n               \n    \n                    var status = 'Payment Initiated'\n                    var address = {recipient_name: options.recipient_name, line1: options.line1, city: options.city, postal_code: options.postal_code, state: '-',country: options.country_code}\n                    var orderDetails = {\n                        orderNo: orderNo,\n                        uid: options.uid,\n                        email: options.email,\n                        phone: options.phone,\n                        address: address,\n                        status: status,\n                        items: data,\n                        payment : {id: orderNo, state:\"Created\", cart:null, pollurl:pollUrl,email:options.email },\n                        amount: {total: subtotal/100, currency: options.currency_code},\n                        exchange_rate: options.exchange_rate,\n                        created: Date.now(),\n                        payment_method: 'Pay Now'\n                                        \n                    }\n                    // Order.create is from order.model not from order.controller\n                    Order.create(orderDetails);\n\n       \n\n\n                    //redirect to paynow for user to complete payment\n                     \n                      res.redirect(theProcessUrl);\n                           \n                \n            }\n        }\n        else {                      \n            //unknown status or one you dont want to handle locally\n             error =  \"Invalid status in from Paynow, cannot continue.\";\n        }\n\n        }\n\n\n\n    });//end request\n      \n      \n\n}\n});\nrouter.get('/process', function(req, res) {\n    var paymentId = req.query.paymentId;\n    var payerId = { 'payer_id': req.query.PayerID };\n    var string = \"\"\n    paypal.payment.execute(paymentId, payerId, function(error, payment){\n        if(error){\n            // console.log('payment process error', error);\n            Order.findOneAndUpdate({'payment.id': paymentId}, {status: 'Payment Error'}, {upsert: false, setDefaultsOnInsert: true, runValidators: true}).exec()\n            string = encodeURIComponent('Error occured while receiving payment');\n            res.redirect('/checkout?id='+paymentId+'&msg=' + string);\n        } else {\n            var mailParams = {\n                id: payment.id,\n                to: payment.payer.payer_info.email,\n                orderNo: payment.transactions[0].invoice_number,\n                status: payment.state,\n                payment_method: payment.payer.payment_method,\n                amount : payment.transactions[0].amount,\n                address: payment.payer.payer_info.shipping_address\n            } \n            // console.log('payment success', payment);\n            if (payment.state === 'approved'){ \n                // Save order details so that if no response received, status will Awaiting Payment\n                Order.findOneAndUpdate({'payment.id': payment.id}, {status: 'Paid'}, {upsert: false, setDefaultsOnInsert: true, runValidators: true}).exec()\n                .then(function(doc){\n                    sendmail.send(config.mailOptions.orderPlaced(mailParams))\n                    string = encodeURIComponent(\"Order Placed\")\n                    res.redirect('/order?id='+paymentId+'&msg=' + string)\n                }).then(function(err){\n                    if(err){\n                        // console.log('Could not find the payment reference',err);\n                        sendmail.send(config.mailOptions.orderPlaced(mailParams))\n                        string = encodeURIComponent(\"Payment Received\")\n                        res.redirect('/order?id='+paymentId+'&msg=' + string)\n                    }\n                })\n            } else {\n                Order.findOneAndUpdate({'payment.id': payment.id}, {status: 'Payment Not Approved'}, {upsert: false, setDefaultsOnInsert: true, runValidators: true}).exec()\n                string = encodeURIComponent('Payment Not Approved');\n                res.redirect('/checkout?id='+paymentId+'&msg=' + string);\n            }\n        }\n})\n});\n\nrouter.get('/gettingbackfrompaynow', function(req, res) {\n\n\n     //Get locally saved  order settings\n     //get latest order from db\n     //\n     //***Todo add userid in query***\n     \n       Order.findOne({},{$sort:{'created_at':-1}}).exec()\n                .then(function(doc){\n\n                    console.log('#################getting back from paynow##############');\n                    console.log(doc);\n\n                     var paymentId = doc.payment.id;\n                     var pollurl   =  doc.payment.pollurl;\n\n                    //poll paynow for payment update\n                    \n                      request({\n                            url: pollurl,\n                            method: \"POST\",\n                            json: true,   // <--Very important!!!\n                            body: ''\n                            }, function (error, response, body){\n\n                            if(response) {  \n                      \n                            //close connection  \n                            var msg = ParseMsg(response.body);  \n                              \n                            var MerchantKey = 'b717de9d-d716-49ae-abae-df8279ceda9b';  \n                            var validateHash = CreateHash(msg, MerchantKey);  \n                      \n                            if(validateHash != msg[\"hash\"]){  \n                                console.log('Invalid hash detected');\n                                //header(\"Location: $checkout_url\");  \n                            }  \n                            else  \n                            {  \n                                /***** IMPORTANT **** \n                                On Paynow, payment status has changed, say from Awaiting Delivery to Delivered \n                                 \n                                    Here is where you \n                                    1. Update your local shopping cart of Payment Status etc and do appropriate actions here, Save data to DB \n                                    2. Email, SMS Notifications to customer, merchant etc \n                                    3. Any other thing \n                                 \n                                *** END OF IMPORTANT ****/  \n\n\n                                 \n                                // console.log('payment success', payment);\n                                if (msg[\"status\"]  === PS_PAID||msg['status'] === PS_AWAITING_DELIVERY|| msg['status'] === PS_DELIVERED){ \n                                    // Save order details so that if no response received, status will Awaiting Payment\n                                    Order.findOneAndUpdate({'orderNo': msg[\"reference\"]}, {status: 'Paid'}, {upsert: false, setDefaultsOnInsert: true, runValidators: true}).exec()\n                                    .then(function(doc){\n\n                                        var mailParams = doc;\n\n                                        mailParams.id = msg[\"paynowreference\"];\n                                        mailParams.to = doc.email;\n\n                                        sendmail.send(config.mailOptions.orderUpdated(mailParams));\n\n                                        var  string = encodeURIComponent(\"Payment Received\")\n                                        res.redirect('/order?id='+msg[\"paynowreference\"]+'&msg=' + string)\n                                       \n\n                                    }).then(function(err){\n                                        if(err){\n                                            // console.log('Could not find the payment reference',err);\n                                            var  string = encodeURIComponent(\"Payment Received\")\n                                            res.redirect('/order?id='+msg[\"paynowreference\"]+'&msg=' + string)\n                                            \n                                        }\n                                    })\n                                } if(msg['status'] === PS_CANCELLED ){\n\n                                    Order.findOneAndUpdate({'orderNo': msg[\"reference\"]}, {status: msg[\"status\"]}, {upsert: false, setDefaultsOnInsert: true, runValidators: true}).exec();\n                                    var string = encodeURIComponent('Payment Cancelled');\n\n                                    res.redirect('/checkout?id='+msg[\"paynowreference\"]+'&msg=' + string);\n\n\n                                } else {\n                                    Order.findOneAndUpdate({'orderNo': msg[\"reference\"]}, {status: msg[\"status\"]}, {upsert: false, setDefaultsOnInsert: true, runValidators: true}).exec();\n                                    var string = encodeURIComponent('Payment Not Approved');\n\n                                    res.redirect('/checkout?id='+msg[\"paynowreference\"]+'&msg=' + string);\n                                }\n                                  \n                               \n                            }  \n                        } \n\n\n                     });//end poll request\n\n                   \n                }).then(function(err){\n                    if(err){\n                        // console.log('Could not find the payment reference',err);\n                        sendmail.send(config.mailOptions.orderPlaced(mailParams))\n                        string = encodeURIComponent(\"Payment Received\")\n                        res.redirect('/order?id='+msg[\"paynowreference\"]+'&msg=' + string)\n                }\n        });\n  \n     \n}); \n\nrouter.get('/paynowupdatingus', function(req, res) {\n\n    \n \n    var paymentId = req.query.paynowreference;\n    var pollurl   = req.query.pollurl;\n     \n\n    request({\n        url: pollurl,\n        method: \"POST\",\n        json: true,   // <--Very important!!!\n        body: ''\n        }, function (error, response, body){\n\n        if(response) {  \n  \n        //close connection  \n        var msg = ParseMsg(response.body);  \n          \n        var MerchantKey = 'b717de9d-d716-49ae-abae-df8279ceda9b';  \n        var validateHash = CreateHash(msg, MerchantKey);  \n  \n        if(validateHash != msg[\"hash\"]){  \n            //header(\"Location: $checkout_url\");  \n        }  \n        else  \n        {  \n            /***** IMPORTANT **** \n            On Paynow, payment status has changed, say from Awaiting Delivery to Delivered \n             \n                Here is where you \n                1. Update your local shopping cart of Payment Status etc and do appropriate actions here, Save data to DB \n                2. Email, SMS Notifications to customer, merchant etc \n                3. Any other thing \n             \n            *** END OF IMPORTANT ****/  \n\n\n             \n            // console.log('payment success', payment);\n            if (msg[\"status\"]  === PS_PAID){ \n                // Save order details so that if no response received, status will Awaiting Payment\n                Order.findOneAndUpdate({'orderNo': msg[\"reference\"]}, {status: 'Paid'}, {upsert: false, setDefaultsOnInsert: true, runValidators: true}).exec()\n                .then(function(doc){\n\n                    var mailParams = doc;\n\n                    mailParams.id = msg[\"paynowreference\"];\n                    mailParams.to = doc.email;\n\n                    sendmail.send(config.mailOptions.orderPlaced(mailParams))\n                   \n                }).then(function(err){\n                    if(err){\n                        // console.log('Could not find the payment reference',err);\n                        sendmail.send(config.mailOptions.orderPlaced(mailParams))\n                        string = encodeURIComponent(\"Payment Received\")\n                        res.redirect('/order?id='+msg[\"paynowreference\"]+'&msg=' + string)\n                    }\n                })\n            } else {\n                Order.findOneAndUpdate({'orderNo': msg[\"reference\"]}, {status: msg[\"status\"]}, {upsert: false, setDefaultsOnInsert: true, runValidators: true}).exec();\n                var string = encodeURIComponent('Payment Not Approved');\n\n                //res.redirect('/checkout?id='+msg[\"paynowreference\"]+'&msg=' + string);\n            }\n              \n           \n        }  \n    } \n\n\n });\n});\n\n\nrouter.get('/cancel', function(req, res) {\n    var string = encodeURIComponent('Payment Cancelled');\n    res.redirect('/checkout?msg=' + string);\n});\n\nmodule.exports = router;\n"]}