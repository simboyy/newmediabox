{"version":3,"sources":["api/category/category.controller.js"],"names":["headings","oldTree","index","blind","loaded","all","path","show","create","updateOne","update","destroy","respondWithSubcats","res","statusCode","entity","a","async","require","each","h","callback","push","err","status","json","respondWithResult","saveUpdates","updates","updated","extend","save","then","removeEntity","remove","end","handleEntityNotFound","handleError","send","req","find","exec","catch","p","parent","active","select","name","category","child","slug","parents","toObject","_id","$in","c","sub_categories","populate","sort","$ne","params","findById","id","body","toString","toLowerCase","replace","findOneAndUpdate","doc","i","has"],"mappings":"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","file":"category.controller.js","sourcesContent":["/**\n * Using Rails-like standard naming convention for endpoints.\n * GET     /api/categories              ->  index\n * POST    /api/categories              ->  create\n * GET     /api/categories/:id          ->  show\n * PUT     /api/categories/:id          ->  update\n * DELETE  /api/categories/:id          ->  destroy\n */\n\n'use strict';\n\nimport _ from 'lodash';\nimport Category from './category.model';\n\n\nfunction respondWithSubcats(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function(entity) {\n    if (entity) {\n      var a = [];\n      var async = require(\"async\");\n      async.each(entity, function(h, callback){\n        a.push(h);\n        callback();\n      },function(err){\n        res.status(statusCode).json(a);\n      })\n    }\n  };\n}\n\nfunction respondWithResult(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function(entity) {\n    if (entity) {\n      res.status(statusCode).json(entity);\n    }\n  };\n}\n\nfunction saveUpdates(updates) {\n  return function(entity) {\n    var updated = _.extend(entity, updates);\n    return updated.save()\n      .then(updated => {\n        return entity;\n      });\n  };\n}\n\nfunction removeEntity(res) {\n  return function(entity) {\n    if (entity) {\n      return entity.remove()\n        .then(() => {\n          res.status(204).end();\n        });\n    }\n  };\n}\n\nfunction handleEntityNotFound(res) {\n  return function(entity) {\n    if (!entity) {\n      res.status(404).end();\n      return null;\n    }\n    return entity;\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    res.status(statusCode).send(err);\n  };\n}\n\n// Get list of headings\nexport function headings(req, res) {\n  Category.find().exec()\n  .then(respondWithSubcats(res))\n  .catch(handleError(res));\n}\n\n// Get all categories with corresponding sub_categories\nexport function oldTree(req, res) {\n  var async = require(\"async\");\n  var p = [];\n  Category.find({parent:null, active:true}).select({name:1,category:1,parent:1,child:1,slug:1}).exec(function(err,parents){\n  // Using async library which will enable us to wait until data received from database\n  async.each(parents, function(a, callback){\n      a = a.toObject();\n      Category.find({_id: {$in: a}}).select({name:1,category:1,parent:1,slug:1}).exec(function(err,c){\n        a.sub_categories = c;\n        p.push(a);\n        callback();\n      });\n    },\n    // 3rd param is the function to call when everything's done\n    function(err){\n      if( err ) { return res.status(404).send('Not Found'); } else { return res.status(200).json(p); }\n    }\n  );\n});\n\n}\n\n// Gets a list of Categories\nexport function index(req, res) {\n  return Category.find({parent: null}).\n  populate({path: 'child', populate: ({ path: 'child',populate: ({ path: 'child', populate: ({ path: 'child', populate: ({ path: 'child', populate: ({ path: 'child',populate: ({ path: 'child',populate: ({ path: 'child',populate: ({ path: 'child' }) }) }) }) }) }) }) })\n  }).exec()\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n// Gets a list of Categories\nexport function blind(req, res) {\n  return Category.\n  find({child: null}).exec()\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n// Get only those categories which has a product ** Not working\nexport function loaded(req, res) {\n  return Category.find({parent: null}).\n  populate({path: 'child', populate: ({ path: 'child',populate: ({ path: 'child', populate: ({ path: 'child', populate: ({ path: 'child', populate: ({ path: 'child',populate: ({ path: 'child',populate: ({ path: 'child',populate: ({ path: 'child' }) }) }) }) }) }) }) })\n  }).sort('-name').exec()\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n// Gets a list of Categories\nexport function all(req, res) {\n  return Category.find({ parent: { $ne: null } }).populate({path:'parent'}).sort({name:1}).exec()\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\nexport function path(req, res) {\n  return Category.find({_id: req.params.category}).\n  populate({\n    path: 'parent',\n    // Get categories of categories - populate the 'categories' array for every category\n    populate: [{ path: 'parent' },{ path: 'child' }]\n  }).exec()\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n// Gets a single Category from the DB\nexport function show(req, res) {\n  return Category.findById(req.params.id).exec()\n    .then(handleEntityNotFound(res))\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n// Creates a new Category in the DB\nexport function create(req, res) {\n  if(!req.body.slug && req.body.name)\n    req.body.slug = req.body.name.toString().toLowerCase().replace(/\\s+/g, '-').replace(/[^\\w\\-]+/g, '').replace(/\\-\\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');\n  return Category.create(req.body)\n    .then(respondWithResult(res, 201))\n    .catch(handleError(res));\n}\n\n// Updates an existing Category in the DB\nexport function updateOne(req, res) {\n  Category.findOneAndUpdate(\n    { \"_id\": req.body.parent, \"subcat._id\": req.body._id },\n    { \n        \"$set\": {\n            \"subcat.$\": req.body\n        }\n    },\n    function(err,doc) {\n      if( err ) { return res.status(404).send('Not Found'); } else { return res.status(200).json(doc); }\n    }\n  );\n}\n\n// Updates an existing Category in the DB\nexport function update(req, res) {\n  if(!req.body.slug && req.body.name)\n    req.body.slug = req.body.name.toString().toLowerCase().replace(/\\s+/g, '-').replace(/[^\\w\\-]+/g, '').replace(/\\-\\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');\n    var c = [];\n  _.each(req.body.child, function (i) {\n    if(_.has(i, '_id')){\n      c.push(i._id);\n    }else if(i){\n      c.push(i);\n    }\n  })\n  req.body.child = c;\n  if (req.body._id) {\n    delete req.body._id;\n  }\n  return Category.findById(req.params.id).exec()\n    .then(handleEntityNotFound(res))\n    .then(saveUpdates(req.body))\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n// Deletes a Category from the DB\nexport function destroy(req, res) {\n  return Category.findById(req.params.id).exec()\n    .then(handleEntityNotFound(res))\n    .then(removeEntity(res))\n    .catch(handleError(res));\n}\n"]}